---
title: "PBA_AS5"
author: "Yung Hsi Liu_114078509"
format:
  pdf:
    toc: true                    
    number-sections: true        
    papersize: A4
    geometry:
      - margin=1in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(tidyverse)
library(infer)
```

# Question 1

## Rubric: Qmd file compiling

```{r}
cbt <- read_csv("https://bit.ly/3KfrFtx")
glimpse(cbt)
```
## Rubric: New variables

```{r}
set.seed(02138)
cbt <- cbt |>
  mutate(
    cbt_assigned = if_else(tpassigned == 1, "CBT", "No CBT"),
    unhoused_baseline = if_else(homeless_baseline == 1, "Unhoused","Housed")
  )
```

## Rubric: Correct `base_diff`

```{r}
base_diff <- cbt |>
  specify(unhoused_baseline ~ cbt_assigned, success="Unhoused") |>
  calculate(stat="diff in props", order=c("CBT", "No CBT"));base_diff
```
## Rubric: `base_p`

```{r}
base_p <- cbt |>
  specify(unhoused_baseline ~ cbt_assigned, success="Unhoused") |>
  hypothesize(null="independence") |>
  generate(reps=1000, type="permute") |>
  calculate(stat="diff in props", order=c("CBT", "No CBT")) |>
  get_p_value(obs_stat=base_diff, direction="both");base_p
```
## Rubric: Reporting the difference/p-value and the rejection or not decision

The observed difference is −0.006. The two-sided p-value is more than 0.85, so we fail to reject the null hypothesis at the 0.05 level, indicating no significant difference between the two groups.

## Rubric: Correct error type
Since the null hypothesis is not rejected, the main concern is a Type II error, where a true difference exists but the test fails to detect it.

# Question 2

## Rubric: `base_diff_attend`

```{r}
set.seed(02138)

cbt <- cbt |>
  mutate(
    cbt_attended = if_else(attend_80 == 1, "Attended CBT", "Not Attended"),
  )

base_diff_attend <- cbt |>
  filter(!is.na(attend_80)) |>
  specify(unhoused_baseline ~ cbt_attended, success="Unhoused") |>
  calculate(stat="diff in props", order=c("Attended CBT", "Not Attended"));base_diff_attend
```

## Rubric: `base_p_attend`
```{r}
base_p_attend <- cbt |>
  filter(!is.na(attend_80)) |>
  specify(unhoused_baseline ~ cbt_attended, success="Unhoused") |>
  hypothesize(null="independence") |>
  generate(reps=1000, type="permute") |>
  calculate(stat="diff in props", order=c("Attended CBT", "Not Attended")) |>
  get_p_value(obs_stat=base_diff_attend, direction="both");base_p_attend
```

## Rubric: Reporting the difference/p-value and the rejection or not decision
The observed difference in baseline proportions is −0.147. The two-sided permutation test yields a p-value of 0, so we reject the null hypothesis at the 0.05 level, indicating a significant difference between those who attended CBT and those who did not.

## Rubric: Correct error type
Since the null hypothesis is rejected, the main concern is a Type I error, where we incorrectly conclude that a difference exists when it does not.

## Rubric: Correctly identifying what parameter controls this error
The Type I error is controlled by the significance level alpha.

# Question 3

## Rubric: Identifying which variable should be used
The CBT assignment should be used as the treatment variable.

## Rubric: Justification
This is because CBT assignment is randomized and balanced at baseline, while actual attendance is not random and would introduce bias.

# Question 4
## Rubric: `ate`
```{r}
set.seed(02138)

ate <- cbt |>
  specify(fam_asb_st ~ cbt_assigned) |>
  calculate(stat="diff in means", order=c("CBT", "No CBT"));ate
```
## Rubric: `ate_null_dist`
```{r}
ate_null_dist <- cbt |>
  specify(fam_asb_st ~ cbt_assigned) |>
  hypothesize(null="independence") |>
  generate(reps=1000, type="permute") |>
  calculate(stat="diff in means", order=c("CBT", "No CBT"));ate_null_dist
```
## Rubric: `ate_p`
```{r}
ate_p <- ate_null_dist |>
  get_p_value(obs_stat=ate, direction="both");ate_p
```
## Rubric: Plot of the null distribution
```{r}
ate_null_dist |>
  visualize()+
  shade_p_value(obs_stat=ate, direction="both");ate_p
```

## Rubric: Explanation of the null distribution and reporting if null is rejected
The null distribution shows the differences in means we would expect if CBT had no effect. Since the observed ATE (-0.22) lies in the extreme tail and the p-value is 0, we reject the null hypothesis at the 0.05 level.

# Question 5
## Rubric: `ate_lt`
```{r}
set.seed(02138)

ate_lt <- cbt |>
  specify(fam_asb_lt ~ cbt_assigned) |>
  calculate(stat="diff in means", order=c("CBT", "No CBT"));ate_lt
```

## Rubric: `ate_lt_null_dist`
```{r}
ate_lt_null_dist <- cbt |>
  specify(fam_asb_lt ~ cbt_assigned) |>
  hypothesize(null="independence") |>
  generate(reps=1000, type="permute") |>
  calculate(stat="diff in means", order=c("CBT", "No CBT"));ate_lt_null_dist
```

## Rubric: `ate_lt_p`
```{r}
ate_lt_p <- ate_lt_null_dist |>
  get_p_value(obs_stat=ate_lt, direction="both");ate_lt_p
```

## Rubric: Plot of the null distribution
```{r}
ate_lt_null_dist |>
  visualize()+
  shade_p_value(obs_stat=ate_lt, direction="both");ate_lt_p
```
## Rubric: Reporting if null is rejected and describing the persistence over time.
The long-term ATE shows that the CBT group still has lower anti-social behavior, with a p-value of 0, so we reject the null hypothesis at the 0.05 level. Compared to Question 4, the effect persists over time but is smaller in the long term, suggesting that the impact of CBT diminishes but does not disappear.